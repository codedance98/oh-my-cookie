<template>
    <div class='root'>
      
      <div v-if='showSetting' class='main'>
        <header>
            <appHeader @showSettingHandle='showSettingHandle' @exportJson='exportJson' @removeAll='removeAll' @changeType="changeType"/>
        </header>
        <div class='content'>
                        <!-- <button @click='exportJson'>导出JSON格式cookie</button> -->
            <!-- <el-input class='input' v-model="url" placeholder="Write the url" clearable @keyup.enter.native='getCookies(input)'></el-input> -->
            <input class='exportJson'  ref='exportJson' v-model='JSONCookie'/>
            <el-table
              :data="tableData"
              :empty-text="$t('lang.empty')"
              stripe
              border
              @row-click="clickTable"
              ref="refTable"
              style="width: 100%"
              v-if="type=='Cookie'"
            >
              <el-table-column type="expand">
                <template slot-scope="props">
                  <el-form label-position="left" inline class="demo-table-expand">
                    <el-form-item label="domain">
                      <span>{{ props.row.domain }}</span>
                    </el-form-item>
                    <el-form-item label="name">
                      <span>{{ props.row.name }}</span>
                    </el-form-item>
                    <el-form-item label="value">
                      <el-input
                        readonly
                        type="textarea"
                        :rows="2"
                        placeholder="请输入内容"
                        v-model="props.row.value">
                      </el-input>
                    </el-form-item>
                    <el-form-item label="path">
                      <span>{{ props.row.path }}</span>
                    </el-form-item>
                    <el-form-item label="expiration">
                      <span>{{ numberToTime(props.row.expirationDate) }}</span>
                    </el-form-item>
                    <el-form-item label="hostOnly">
                      <span>{{ props.row.hostOnly }}</span>
                    </el-form-item>
                    <el-form-item label="sameSite">
                      <span>{{ props.row.sameSite }}</span>
                    </el-form-item>
                    <el-form-item label="secure">
                      <span>{{ props.row.secure }}</span>
                    </el-form-item>
                    <el-form-item label="session">
                      <span>{{ props.row.session }}</span>
                    </el-form-item>
                  </el-form>
                </template>
              </el-table-column>
              <el-table-column
                label="domain"
                align='center'
                show-overflow-tooltip
                prop="domain">
              </el-table-column>
              <el-table-column
                label="name"
                show-overflow-tooltip
                align='center'
                prop="name">
              </el-table-column>
              <el-table-column
                class='cookie-value'
                label="value"
                align='center'
                show-overflow-tooltip
                prop="value">
              </el-table-column>
              <el-table-column
                class='cookie-value'
                label="more"
                align='center'
                show-overflow-tooltip
                >
                <template slot-scope='scope'>
                  <!-- <i class="el-icon-edit" @click.stop="handleEdit(scope.$index, scope.row)"></i>
                  <i class="el-icon-delete" @click.stop='handleDele(scope.$index, scope.row)'></i> -->
                  <el-button
                      size="mini"
                      @click="handleEdit(scope.$index, scope.row)"><i class="el-icon-edit" @click.stop="handleEdit(scope.$index, scope.row)"></i></el-button>
                    <el-button
                      size="mini"
                      type="danger"
                      @click.stop='handleDele(scope.$index, scope.row)'
                      ><i class="el-icon-delete"></i></el-button>
                </template>
                <!-- <template slot="header" slot-scope="scope">
                  <el-input
                    v-model="search"
                    size="mini"
                    @change='filterValue(search)'
                    width='30'
                    clearable
                    placeholder="值搜索"/>
                </template> -->
              </el-table-column>
            </el-table>
            <el-table
              :data="tableData"
              :empty-text="$t('lang.empty')"
              stripe
              border
              @row-click="clickTable"
              ref="refTable"
              style="width: 100%"
              v-else
            >
              <el-table-column type="expand">
                <template slot-scope="props">
                  <el-form label-position="left" inline class="demo-table-expand">
                    <el-form-item v-for="item in props.row.data" :key="item.name" :label="item.name">
                      <span>{{ item.value }}</span>
                    </el-form-item>
                  </el-form>
                </template>
              </el-table-column>
              <el-table-column label="name" show-overflow-tooltip align="center" prop="name"></el-table-column>
              <el-table-column
                class="cookie-value"
                label="value"
                align="center"
                show-overflow-tooltip
                prop="value"
              ></el-table-column>
            </el-table>
            <!-- 对话窗 -->
            <el-dialog title="" :visible.sync="dialogFormVisible">
            <el-form :model="form">
              <el-form-item label="domain" >
                <el-input v-model="form.domain" autocomplete="off"></el-input>
              </el-form-item>
              <el-form-item label="name">
                <el-input v-model="form.name" autocomplete="off"></el-input>
              </el-form-item>
              <el-form-item label="value" >
                <el-input type="textarea" :rows="2" v-model="form.value" autocomplete="off"></el-input>
              </el-form-item>
              <el-form-item label="expirationDate" >
                <el-input v-model="form.expirationDate" autocomplete="off"></el-input>
              </el-form-item>
              <el-form-item label="path" >
                <el-input v-model="form.path" autocomplete="off"></el-input>
              </el-form-item>
              <el-form-item label="sameSite" >
                <el-input v-model="form.sameSite" autocomplete="off"></el-input>
              </el-form-item>
              <el-form-item label="httpOnly" >
                <el-tooltip :content="'httpOnly value: ' + form.httpOnly" placement="top">
                  <el-switch v-model="form.httpOnly">
                  </el-switch>
                </el-tooltip>
              </el-form-item>
              <el-form-item label="secure" >
                <el-tooltip :content="'secure value: ' + form.secure" placement="top">
                  <el-switch
                    v-model="form.secure" >
                  </el-switch>
                </el-tooltip>
              </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
              <el-button @click="dialogFormVisible = false">{{$t('lang.cancel')}}</el-button>
              <el-button type="primary" @click="submit">{{$t('lang.save')}}</el-button>
            </div>
          </el-dialog>
          </div>
      </div>

      <div v-else class='setting'>
        <setting  @hideSettingHandle='hideSettingHandle'/>
      </div>
      
  </div>
</template>
<script>
import './style/base.scss';
import detail from './table';
import appHeader from './header';
import setting from './setting'
  export default {
    data: () => {  
      return{
         tableData:[],
         scope:'',
         url:'',
         search:'',
         currentPage:'',
         dialogFormVisible:false,
         showSetting:true,
         type: "Cookie",
         form:{
           domain:'',
           name:'',
           value:'',
           path: '',
           sameSite:'',
           hostOnly:false,
           httpOnly:false,
           secure:true,
           session:false
         }
      }
    },
    computed: { 
      JSONCookie(){
        return JSON.stringify(this.tableData)
      }
    },
    created () {
       let self = this;
       chrome.tabs.query({"status":"complete","windowId":chrome.windows.WINDOW_ID_CURRENT,"active":true}, function(tab){
          self.currentPage = tab[0].url;
          self.getCookies(tab[0].url);
       })
    },
    methods: {
      getData() {
        console.log(localStorage.getItem("type"));
        let self = this;
        chrome.tabs.query(
          {
            status: "complete",
            windowId: chrome.windows.WINDOW_ID_CURRENT,
            active: true
          },
          function(tab) {
            self.currentPage = tab[0].url;
            self.type = localStorage.getItem("type") || "Cookie";
            if (self.type == "Cookie") {
              self.getCookies(tab[0].url);
            } else if (self.type == "LocalStorage") {
              self.getLocalStorage(tab[0].id);
            } else if (self.type == "SessionStorage") {
              self.getSessionStorage(tab[0].id);
            }
          }
        );
      },
      changeType() {
        this.getData();
      },
      handleClick(tab, event) {
        console.log(tab, event);
      },
      getCookies(url){
        this.loading = true;
        let self = this;
        chrome.cookies.getAll({"url":url},function (res){
          self.tableData = res
          setTimeout(()=>{
            self.loading = false
          },300)
        })
      },    
      getLocalStorage(tabId) {
        this.getStorage(tabId, "localStorage");
      },
      getSessionStorage(tabId) {
        this.getStorage(tabId, "sessionStorage");
      },
      getStorage(tabId, name) {
        let self = this;
        chrome.tabs.executeScript(
          tabId,
          { code: `JSON.stringify(` + name + `)` },
          function(d) {
            var data = JSON.parse(d);
            self.tableData = [];
            for (var name in data) {
              var item = {};
              item.name = name;
              item.value = data[name];
              try {
                var parsedData = JSON.parse(data[name]);
                item.data = [];
                if (parsedData instanceof Object) {
                  item.data = [];
                  for (var key in parsedData) {
                    var kv = [];
                    kv.name = key;
                    kv.value = parsedData[key];
                    item.data.push(kv);
                  }
                } else if (typeof parsedData == "string") {
                  item.value = parsedData;
                }
              } catch (e) {
                item.data = [];
              }
              self.tableData.push(item);
            }
            console.log(self.tableData);
          }
        );
      },
      deleteCookie(idx){
        this.tableData = this.tableData.filter((item,index)=>{return idx != index})
      },
      removeAll(){
        this.tableData = [];
      },
      clickTable(row,index,e){
           this.$refs.refTable.toggleRowExpansion(row)
      },
      numberToTime(timenumber) {
          let t = timenumber*1000;
          const date = new Date(t)
          const Y = date.getFullYear() + '-'
          const M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-'
          const D = date.getDate() < 10 ? '0' + date.getDate() : date.getDate()
          let h = date.getHours() < 10 ? '0' + date.getHours() + ':' : date.getHours() + ':'
          let m = date.getMinutes() < 10 ? '0' + date.getMinutes() + ':' : date.getMinutes() + ':'
          let s = date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds()
          return Y + M + D + ' ' + h + m + s
      },
      handleEdit(index,data){
        this.form = {...data}
        this.dialogFormVisible = true;
      },
      handleDele(index,data){
        chrome.cookies.remove({url:this.currentPage, name: data.name},
        (res)=>{
          this.$message({
            message: `${res.name} is deleted`,
            type: 'success'
          });
          this.tableData = this.tableData.filter((item)=>{return item.name != res.name})
        });
      },
      submit(){
        let self = this
        let temp = this.form
        delete temp.hostOnly
        delete temp.session
        chrome.cookies.set({
            "url": self.currentPage,
            ...temp
        }, function (cookie) {
            //reload
            self.getCookies(self.currentPage);
            self.dialogFormVisible = false
            self.$message({
              message: `update successful`,
              type: 'success'
            });
        });
      },
      // 暂时不用
      filterValue(v){
        if(!v.length){
          let self = this
          chrome.tabs.query({"status":"complete","windowId":chrome.windows.WINDOW_ID_CURRENT,"active":true}, function(tab){
              self.getCookies(tab[0].url);
          })
        }else{
          this.tableData = this.tableData.filter((i)=>{return i.value.indexOf(v) !== -1})
        }
      },
      exportJson(){
        const input = this.$refs.exportJson
        input.select();
        if (document.execCommand('copy')) {
          document.execCommand('copy');
          this.$message({
            message: `copy successful`,
            type: 'success'
          });
        }else{
          console.log('当前浏览器不支持复制')
        }
      },
      showSettingHandle(){
        this.showSetting = false
      },
      hideSettingHandle(){
        this.showSetting = true
      }
    },
    components:{
      detail,
      appHeader,
      setting
    }
  }
</script>
<style lang="scss">
  body::-webkit-scrollbar { width: 0 !important };
  .root {
    width:600px;
    height:400px;
    position:relative;
    padding:2px 5px 10px;
    .header{
      width:100%;
      position:fixed;
      top:0;
      left:0;
      background-color:#fff;
      z-index:2;
    }
    .content{
      padding-top:45px;
        .el-dialog__header{
          padding:0;
        }
        .input{
          margin-bottom:10px;
        }
        .exportJson {
          position:absolute;
          left:-1000px;
        }
        .demo-table-expand {
          font-size: 0;
        }
        .demo-table-expand label {
          width: 90px;
          color: #99a9bf;
        }
        .demo-table-expand .el-form-item {
          margin-right: 0;
          margin-bottom: 0;
          // width: 50%;
        }
        .el-form--inline .el-form-item{
          display:block;
          .el-form-item__content{
            width:81%;
          }
        }
        .el-table__row{
          cursor: pointer;
          .el-textarea{
            width:100%;
          }
        }
        .el-dialog{
          width:90%;
          .el-form-item{
            margin-bottom:0px;
          }
        }
      }
    }
</style>